# 测试目录

本目录包含项目的所有测试文件，使用 Vitest 测试框架。所有测试可以通过 `pnpm test` 命令统一运行。

## 目录结构

```
tests/
├── README.md                    # 本文件
├── unit/                        # 单元测试
│   ├── auth.service.test.ts     # 认证服务测试（13个测试）
│   ├── models.test.ts           # 数据模型测试（33个测试）
│   ├── task.service.test.ts     # 任务服务测试（17个测试）
│   ├── log.service.test.ts      # 日志服务测试（14个测试）
│   ├── api-routes.test.ts       # API路由测试（21个测试）
│   └── health.routes.test.ts    # 健康检查路由测试（8个测试）
├── integration/                 # 集成测试
│   ├── task-execution.test.ts   # 任务执行集成测试（32个测试）
│   └── api-integration.test.ts  # API集成测试（12个测试）
├── e2e/                         # 端到端测试
│   └── user-workflow.test.ts    # 用户工作流程测试（7个测试）
└── property/                    # 属性测试（待添加）
```

## 快速开始

### 运行所有测试
```bash
pnpm test
```

### 监听模式（开发时使用）
```bash
pnpm test:watch
```
文件修改后自动重新运行测试

### 可视化UI界面
```bash
pnpm test:ui
```
在浏览器中查看测试结果和覆盖率

### 生成测试覆盖率报告
```bash
pnpm test:coverage
```

## 测试框架配置

### 已安装的依赖
```json
{
  "devDependencies": {
    "vitest": "^4.0.18",
    "@vitest/ui": "^4.0.18",
    "happy-dom": "^20.5.0"
  }
}
```

### Vitest 配置
**配置文件**: `vitest.config.ts`

主要配置：
- **测试环境**: happy-dom（轻量级DOM环境）
- **测试文件匹配**: `tests/**/*.{test,spec}.{js,mjs,cjs,ts,mts,cts,jsx,tsx}`
- **排除目录**: node_modules, dist, .wrangler
- **超时设置**: 10秒
- **路径别名**: 
  - `@` → `src/` 目录
  - `@server` → `server/` 目录

### 测试脚本
```json
{
  "scripts": {
    "test": "vitest run",                    // 运行所有测试
    "test:watch": "vitest",                  // 监听模式
    "test:ui": "vitest --ui",                // 可视化界面
    "test:coverage": "vitest run --coverage" // 覆盖率报告
  }
}
```

## 已实现的测试

### unit/auth.service.test.ts（13个测试用例）

#### 密码哈希和验证（4个测试）
- ✅ 应该成功哈希密码
- ✅ 应该验证正确的密码
- ✅ 应该拒绝错误的密码
- ✅ 相同密码应该生成相同的哈希

#### JWT令牌生成和验证（5个测试）
- ✅ 应该成功生成JWT令牌
- ✅ 应该验证有效的JWT令牌
- ✅ 应该拒绝无效的JWT令牌
- ✅ 应该拒绝使用错误密钥签名的令牌
- ✅ 应该拒绝过期的令牌

#### 令牌提取（4个测试）
- ✅ 应该从Authorization头中提取Bearer令牌
- ✅ 无Authorization头时应返回null
- ✅ Authorization头格式错误时应返回null
- ✅ 只有Bearer关键字时应返回null

### unit/models.test.ts（31个测试用例）

#### 用户模型验证（8个测试）
- ✅ 应该验证有效的用户名
- ✅ 应该拒绝无效的用户名
- ✅ 应该验证有效的密码
- ✅ 应该拒绝无效的密码
- ✅ 应该验证有效的用户角色
- ✅ 应该拒绝无效的用户角色
- ✅ 应该验证完整的用户数据
- ✅ 应该拒绝无效的用户数据

#### 任务模型验证（9个测试）
- ✅ 应该验证有效的任务名称
- ✅ 应该拒绝无效的任务名称
- ✅ 应该验证有效的任务类型
- ✅ 应该拒绝无效的任务类型
- ✅ 应该验证有效的Cron表达式
- ✅ 应该拒绝无效的Cron表达式
- ✅ 应该验证有效的保活任务配置
- ✅ 应该拒绝无效的保活任务配置
- ✅ 应该验证有效的通知任务配置

#### 执行日志模型验证（8个测试）
- ✅ 应该验证有效的任务ID
- ✅ 应该拒绝无效的任务ID
- ✅ 应该验证有效的执行状态
- ✅ 应该拒绝无效的执行状态
- ✅ 应该验证有效的响应时间
- ✅ 应该拒绝无效的响应时间
- ✅ 应该验证有效的HTTP状态码
- ✅ 应该拒绝无效的HTTP状态码

#### 通知设置模型验证（6个测试）
- ✅ 应该验证有效的邮箱地址
- ✅ 应该拒绝无效的邮箱地址
- ✅ 应该验证有效的Webhook URL
- ✅ 应该拒绝无效的Webhook URL
- ✅ 应该验证有效的失败阈值
- ✅ 应该拒绝无效的失败阈值

### integration/task-execution.test.ts（32个测试用例）

#### 保活任务HTTP请求执行（6个测试）
- ✅ 应该使用正确的HTTP方法和URL发送GET请求
- ✅ 应该使用正确的HTTP方法和请求体发送POST请求
- ✅ 应该记录HTTP请求的响应时间
- ✅ 应该正确处理HTTP错误状态码
- ✅ 应该记录执行日志
- ✅ 应该更新任务的最后执行状态

#### 通知任务发送功能（3个测试）
- ✅ 应该使用正确的NotifyX API配置发送通知
- ✅ 应该处理通知发送失败
- ✅ 应该记录通知发送的执行日志

#### 错误处理（5个测试）
- ✅ 应该处理网络超时
- ✅ 应该处理DNS解析失败
- ✅ 应该在失败时记录错误日志
- ✅ 应该在失败时更新任务状态为failure

#### 前后端API集成（10个测试）
- ✅ 应该成功注册新用户并返回令牌
- ✅ 应该拒绝已存在的用户名
- ✅ 应该成功认证有效用户
- ✅ 应该拒绝错误的密码
- ✅ 应该成功验证有效令牌
- ✅ 应该拒绝无效令牌
- ✅ 应该成功创建保活任务
- ✅ 应该成功创建通知任务
- ✅ 应该成功更新任务
- ✅ 应该拒绝无权限的更新操作

#### 任务执行统计（2个测试）
- ✅ 应该正确计算任务执行统计
- ✅ 应该处理没有执行日志的情况

#### 数据库操作集成（3个测试）
- ✅ 应该在数据库操作失败时进行重试
- ✅ 应该拒绝无效的任务配置
- ✅ 应该拒绝无效的用户名格式

### integration/api-integration.test.ts（12个测试用例）

#### 认证流程集成（4个测试）
- ✅ 应该完成完整的注册-登录-验证流程
- ✅ 应该正确处理令牌刷新流程
- ✅ 应该从请求头中正确提取令牌
- ✅ 应该拒绝格式错误的Authorization头

#### 任务管理API集成（3个测试）
- ✅ 应该完成完整的任务CRUD流程
- ✅ 应该正确处理任务筛选
- ✅ 应该正确处理启用/禁用任务

#### 错误处理集成（4个测试）
- ✅ 应该正确处理数据库连接失败
- ✅ 应该正确处理不存在的资源
- ✅ 应该正确处理权限错误
- ✅ 应该正确处理验证错误

#### 并发操作集成（1个测试）
- ✅ 应该正确处理并发任务创建

### e2e/user-workflow.test.ts（7个测试用例）

#### 完整的保活任务工作流程（1个测试）
- ✅ 应该完成从创建到执行的完整保活任务流程
  - 用户注册
  - 创建保活任务
  - 验证任务已创建
  - 执行任务
  - 验证执行日志
  - 获取任务统计
  - 禁用任务
  - 删除任务

#### 完整的通知任务工作流程（1个测试）
- ✅ 应该完成从创建到执行的完整通知任务流程
  - 用户登录
  - 创建通知任务
  - 执行通知任务
  - 验证通知已发送
  - 查看执行日志

#### 错误场景和恢复机制（2个测试）
- ✅ 应该正确处理任务执行失败并记录错误
- ✅ 应该正确处理从失败到成功的恢复场景

#### 多任务并发执行场景（1个测试）
- ✅ 应该正确处理多个任务同时执行

#### 用户权限和安全场景（2个测试）
- ✅ 应该阻止用户访问其他用户的任务
- ✅ 应该正确验证令牌过期

## 测试结果

最新测试运行结果：
```
✓ tests/unit/models.test.ts (33 tests) 44ms
✓ tests/unit/log.service.test.ts (14 tests) 72ms
✓ tests/unit/auth.service.test.ts (13 tests) 152ms
✓ tests/unit/task.service.test.ts (17 tests) 84ms
✓ tests/unit/api-routes.test.ts (21 tests) 72ms
✓ tests/unit/health.routes.test.ts (8 tests) 64ms
✓ tests/integration/task-execution.test.ts (32 tests) 233ms
✓ tests/integration/api-integration.test.ts (12 tests) 98ms
✓ tests/e2e/user-workflow.test.ts (7 tests) 1232ms

Test Files  9 passed (9)
     Tests  157 passed (157)
  Duration  5.67s
```

## 编写新测试

### 1. 创建测试文件
在 `tests/unit/` 目录下创建 `.test.ts` 文件：

```typescript
import { describe, it, expect } from 'vitest';

describe('功能描述', () => {
  it('应该做某事', () => {
    // 测试代码
    expect(result).toBe(expected);
  });
});
```

### 2. 运行测试
```bash
pnpm test
```

测试会自动被 Vitest 发现并执行。

## 测试最佳实践

1. **命名规范**: 测试文件使用 `.test.ts` 或 `.spec.ts` 后缀
2. **测试组织**: 使用 `describe` 分组相关测试
3. **测试描述**: 使用清晰的中文描述测试意图
4. **断言**: 使用 Vitest 的 `expect` API
5. **隔离性**: 每个测试应该独立运行，不依赖其他测试

## 框架优势

1. **统一运行**: 所有测试通过一个命令运行，无需单独执行
2. **快速反馈**: Vitest 提供快速的测试执行和热重载
3. **类型安全**: 完整的 TypeScript 支持
4. **易于调试**: 清晰的错误信息和堆栈跟踪
5. **可视化**: 提供 UI 界面查看测试结果
6. **覆盖率**: 内置代码覆盖率报告

## 待添加的测试

根据任务计划，以下测试类型将在后续添加：

### 单元测试 (unit/)
- ✅ 认证服务单元测试（已完成）
- ✅ 数据模型单元测试（已完成）
- ✅ 任务服务单元测试（已完成）
- ✅ 日志服务单元测试（已完成）
- ✅ API路由单元测试（已完成）
- ✅ 健康检查路由单元测试（已完成）

### 集成测试 (integration/)
- ✅ 任务执行集成测试（已完成）
- ✅ API集成测试（已完成）

### 端到端测试 (e2e/)
- ✅ 用户工作流程测试（已完成）

### 属性测试 (property/)
使用 fast-check 库进行基于属性的测试（可选，标记为 `*`）：
- 数据库服务属性测试（任务3.2）
- 认证服务属性测试（任务3.4）
- 任务管理属性测试（任务4.2）
- 任务执行属性测试（任务4.4）
- 调度器属性测试（任务6.2）
- 通知服务属性测试（任务6.4）
- API路由属性测试（任务7.2）
- 速率限制属性测试（任务7.4）
- 日志系统属性测试（任务8.2）
- 监控系统属性测试（任务9.2）

## 测试工具

- **Vitest**: 快速的单元测试框架（✅ 已配置）
- **happy-dom**: 轻量级DOM环境（✅ 已配置）
- **@vitest/ui**: 可视化测试界面（✅ 已配置）
- **fast-check**: 属性测试库（⏳ 待添加）
- **Playwright**: 端到端测试（⏳ 待添加）

## 注意事项

1. **属性测试**: 标记为可选（任务中标记为 `*`），可以跳过以实现更快的MVP
2. **迭代次数**: 每个属性测试应至少运行100次迭代
3. **测试标记**: 格式为 `Feature: app-keepalive-system, Property {number}: {property_text}`
4. **数据库测试**: 需要本地D1数据库实例
5. **统一运行**: 所有测试必须通过 `pnpm test` 命令统一运行

## 下一步计划

- [ ] 添加数据库服务单元测试
- [ ] 添加集成测试
- [ ] 配置 fast-check 进行属性测试
- [ ] 添加 E2E 测试（Playwright）
- [ ] 配置 CI/CD 自动运行测试
- [ ] 提高测试覆盖率到80%以上
